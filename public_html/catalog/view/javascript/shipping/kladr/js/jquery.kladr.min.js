!function(a,n){function l(t,e){return t.hasOwnProperty(e)}function o(t){var e=n.console;e&&e.error&&e.error(t)}a.kladr={},function(){if(""!=a("base").attr("href"))a.kladr.url=a("base").attr("href")+"index.php?route=extension/shipping/shiptor/getkladr";else{var t=n.location.origin;a.kladr.url=t+"index.php?route=extension/shipping/shiptor/getkladr"}}(),a.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},a.kladr.typeCode={city:1,settlement:2,village:4},a.kladr.validate=function(t){var e=a.kladr.type;switch(t.type){case e.region:case e.district:case e.city:if(t.parentType&&!t.parentId)return o("parentId undefined"),!1;break;case e.street:if(t.parentType!=e.city&&t.parentType!=e.street)return o('parentType must equal "city" or "street"'),!1;if(!t.parentId)return o("parentId undefined"),!1;break;case e.building:if(!t.zip){if(!~a.inArray(t.parentType,[e.street,e.city]))return o('parentType must equal "street" or "city"'),!1;if(!t.parentId)return o("parentId undefined"),!1}break;default:if(!t.oneString)return o("type incorrect"),!1}return t.oneString&&t.parentType&&!t.parentId?(o("parentId undefined"),!1):t.typeCode&&t.type!=e.city?(o('type must equal "city"'),!1):!(t.limit<1)||(o("limit must greater than 0"),!1)},a.kladr.api=function(e,n){if(n)if(a.kladr.validate(e)){var r=setTimeout(function(){n([])},2e3);a.ajax({url:a.kladr.url,type:"post",data:function(t){var e={},n={name:"query",country:"country",country_payment:"country_payment"};t.parentType&&t.parentId&&(e[t.parentType+"Id"]=t.parentId);for(var r in t)l(t,r)&&t[r]&&(e[l(n,r)?n[r]:r]=t[r]);return e}(e),dataType:"json"}).done(function(t){r&&(!function(t,e){for(i in html="",e)html+='<option value="'+i+'">'+e[i]+"</option>";a("#"+t).html(html)}(e.regionSelector,t.region),n(t.result||[]),clearTimeout(r))})}else n([]);else o("Callback undefined")},a.kladr.check=function(t,e){e?(t.withParents=!1,t.limit=1,a.kladr.api(t,function(t){t&&t.length?e(t[0]):e(!1)})):o("Callback undefined")}}(jQuery,window),function(I,j,S,t){var C={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,noResultText:null,checkEmptyRespone:!1,strict:null,country:null,country_payment:null,parentInput:null,verify:!1,spinner:!0,regionSelector:null,open:null,close:null,send:null,receive:null,select:null,check:null,change:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(t,e){I.kladr.api(t,e)},labelFormat:function(t,e){var n;if(e.oneString)return t.parents?((n=[].concat(t.parents)).push(t),I.kladr.buildAddress(n)):(t.typeShort?t.typeShort+". ":"")+t.name;var r,a,i,l,o="";return t.typeShort&&(o+=t.typeShort+". "),a=(r=t.name).toLowerCase(),i=e.name.toLowerCase(),l=~(l=a.indexOf(i))?l:0,i.length<a.length?(o+=r.substr(0,l),o+="<strong>",o+=r.substr(l,i.length),o+="</strong>",o+=r.substr(l+i.length)):o+="<strong>"+r+"</strong>",o},valueFormat:function(t,e){var n;return e.oneString?t.parents?((n=[].concat(t.parents)).push(t),I.kladr.buildAddress(n)):(t.typeShort?t.typeShort+". ":"")+t.name:t.name},showSpinner:function(t){var e=-.2,n=setInterval(function(){if(!t.is(":visible"))return clearInterval(n),void(n=null);t.css("background-position","0% "+e+"%"),95<(e+=5.555556)&&(e=-.2)},30);t.show()},hideSpinner:function(t){t.hide()}},o={current:null,controller:null},_={up:38,down:40,enter:13};function a(t,e){var n={obj:!1,str:!1,isGet:!1};return"object"===I.type(t)?n.obj=t:"string"===I.type(t)&&(n.str=[t,e],n.isGet=void 0===e),n}function x(t,e){return t.hasOwnProperty(e)}I.kladr=I.extend(I.kladr,{setDefault:function(t,e){var n=a(t,e);if(n.obj)for(var r in n.obj)x(C,r)&&(C[r]=n.obj[r]);else n.str&&!n.isGet&&x(C,n.str[0])&&(C[n.str[0]]=n.str[1])},getDefault:function(t){if(x(C,t))return C[t]},getInputs:function(t){var e=I(t||S.body),n="[data-kladr-type]";return e.filter(n).add(e.find(n))},setValues:function(t,e){var a,n,i="kladr_change.setvalues",r=I.kladr.type,l={},o={};if(~I.inArray(I.type(t),["object","array"])){for(n in I.each(t,function(t,e){if(e){var n=e.contentType||e.type||t;x(r,n)&&(l[n]=e)}}),r)x(r,n)&&l[n]&&(o[n]=l[n]);a=I.kladr.getInputs(e),function t(){var e,n,r;for(n in o)if(x(o,n)){r=o[n],delete o[n];break}n&&((e=a.filter('[data-kladr-type="'+n+'"]')).length?e.on(i,function(){e.off(i),t()}).kladr("controller").setValue(r):t())}()}},getAddress:function(t,e){var n,r=I.kladr.getInputs(t),a=I.kladr.type,i={},l={};for(n in r.each(function(){var t,e,n,r=I(this);if(r.attr("data-kladr-id"))if(t=r.kladr("current"),r.attr("data-kladr-one-string")&&t.parents)for((e=[].concat(t.parents)).push(t),n=0;n<e.length;n++)i[e[n].contentType]=e[n];else i[r.attr("data-kladr-type")]=t;else i[r.attr("data-kladr-type")]=r.val()}),a)x(a,n)&&i[n]&&(l[n]=i[n]);return(e||I.kladr.buildAddress)(l)},buildAddress:function(t){var i=[],l="",o="";return I.each(t,function(t,e){var n,r="",a="";if("object"===I.type(e)){for(n=0;n<i.length;n++)if(i[n]==e.id)return;i.push(e.id),r=e.name,a=e.typeShort+". ",o=e.zip||o}else r=e;l&&(l+=", "),l+=a+r}),l=(o?o+", ":"")+l}}),I.fn.kladr=function(t,e){var i=a(t,e),l=null;return this.each(function(){var T,t,n,r,a,e=(T=I(this),t=i,r="kladr-data",(a=T.data(r))||(a=I.extend({},C,o),T.data(r,a)),n={set:function(t){if(t.obj)for(var e in t.obj)x(t.obj,e)&&x(C,e)&&(a[e]=t.obj[e]);else t.str&&!t.isGet&&x(C,t.str[0])&&(a[t.str[0]]=t.str[1]);T.data(r,a)},get:function(t){if(x(C,t)||x(o,t))return a[t]},_set:function(t,e){a[t]=e,T.data(r,a)},_get:function(t){if(x(a,t))return a[t]}},function(t,e){if(t.isGet)return n.get(t.str[0]);n.set(t),e()}(t,function(){var d=null,l=null,a=!1,i=".kladr",o="kladrInputChange";function u(){var t=T.offset(),e=T.outerWidth(),n=T.outerHeight();if(t&&(u.top!=t.top||u.left!=t.left||u.width!=e||u.height!=n)){u.top=t.top,u.left=t.left,u.width=e,u.height=n,d.css({top:t.top+n+"px",left:t.left});var r=d.outerWidth()-d.width();d.width(e-r);var a=l.width(),i=l.height();l.css({top:t.top+(n-i)/2-1,left:t.left+e-a-2})}}function t(t){if(!(8<t.which&&t.which<46))if(T.data(o,!1),f("open_before")){k(null);var e=T.val();if(!I.trim(e))return m(!1),void c();var r=h(e);f("send_before",r)?(y(),f("send"),b("source")(r,function(t){return f("receive",t),T.is(":focus")?I.trim(T.val())&&t.length?(a=!0,function(t,e){var n,r,a,i;d.empty();for(var l=0;l<t.length;l++)n=t[l],r=b("valueFormat")(n,e),a=b("labelFormat")(n,e),(i=I('<a data-val="'+r+'">'+a+"</a>")).data("kladr-object",n),I("<li></li>").append(i).appendTo(d)}(t,r),u(),v(),d.slideDown(50),void f("open")):(v(),k(null),d.empty(),null!=(e=C.noResultText)&&""!=e&&((n=I('<a data-val="">'+e+"</a>")).data("kladr-object",{}),I("<li></li>").append(n).appendTo(d)),u(),d.slideDown(50),f("open"),void(a=!1)):(v(),void c());var e,n})):c()}else c()}function c(){f("close_before")&&(d.empty().hide(),f("close"))}function s(t){var e,n,r,a,i,l,o,u=d.find("li.active");switch(t.which){case _.up:u.length?(u.removeClass("active"),u.prev().length&&(u=u.prev())):u=d.find("li").last(),i=d.scrollTop(),l=d.offset(),o=u.outerHeight(),u.offset().top-l.top<0&&d.scrollTop(i-o),u.addClass("active"),p();break;case _.down:u.length?(u.removeClass("active"),u.next().length&&(u=u.next())):u=d.find("li").first(),u.length&&(e=d.scrollTop(),n=d.height(),r=d.offset(),a=u.outerHeight(),u.offset().top-r.top+a>n&&d.scrollTop(e+a)),u.addClass("active"),p();break;case _.enter:d.find("li").first().addClass("active"),p(),c()}}function p(){if(f("select_before")){var t=d.find(".active a");t.length&&(T.val(t.attr("data-val")).data(o,!0),m(!1),k(t.data("kladr-object")),f("select",b("current")))}}function f(t,e){if(!t)return!0;var n=t.replace(/_([a-z])/gi,function(t,e){return e.toUpperCase()});return T.trigger("kladr_"+t,e),"function"!==I.type(b(n))||!1!==b(n).call(T.get(0),e)}function y(){b("spinner")&&b("showSpinner")(l)}function v(){b("spinner")&&b("hideSpinner")(l)}function h(t){var e,n={},r=["token","key","type","typeCode","parentType","parentId","oneString","withParents","limit","strict","country","country_payment","regionSelector"];for(e=0;e<r.length;e++)n[r[e]]=b(r[e]);var a=I("#collapse-payment-address").attr("aria-expanded"),i=I("#collapse-shipping-address").attr("aria-expanded"),l=I("#input-country").val();"true"==a?n.country=I("#input-payment-country").val():"true"==i?n.country=I("#input-shipping-country").val():l&&(n.country=l),n.name=g(t);var o,u=b("parentInput");return u&&(o=function(t,e){var n,r=I.kladr.getInputs(t),a=I.kladr.type,i={},l=null;for(n in r.each(function(){var t,e=I(this);(t=e.attr("data-kladr-id"))&&(i[e.attr("data-kladr-type")]=t)}),a){if(n==e)return l;x(a,n)&&i[n]&&(l={type:n,id:i[n]})}return l}(u,n.type))&&(n.parentType=o.type,n.parentId=o.id),n.oneString&&(n.withParents=!0),n}function g(t){for(var e=t.toLowerCase(),n=0;n<e.length;n++)if(~"abcdefghijklmnopqrstuvwxyz".indexOf(e[n]))return m(!0),t;return m(!1),t}function k(t){var e=b("current");(e&&e.id)!==(t&&t.id)&&(w("current",t),t&&t.id?T.attr("data-kladr-id",t.id):T.removeAttr("data-kladr-id"),b("oneString")&&t&&t.contentType&&T.attr("data-kladr-type",t.contentType),f("change",t))}function m(t){t?T.addClass("kladr-error"):T.removeClass("kladr-error")}function b(t){return n._get(t)}function w(t,e){n._set(t,e)}!function(t){var e=I(S.getElementById("kladr_autocomplete"));e.length||(e=I('<div id="kladr_autocomplete"></div>').appendTo(S.body));var n,r=b("guid");r?(d=e.find(".autocomplete"+r),l=e.find(".spinner"+r),I(j).off(i),T.off(i),d.off(i)):(w("guid",r=function t(){return t.guid?++t.guid:t.guid=1}()),T.attr("autocomplete","off"),d=I('<ul class="autocomplete'+r+' autocomplete" style="display: none;"></ul>').appendTo(e),l=I('<div class="spinner'+r+' spinner" style="display: none;"></div>').appendTo(e),function(){var n={setValue:function(t){return"object"===I.type(t)?n.setValueByObject(t):"number"===I.type(t)?n.setValueById(t):"string"===I.type(t)?n.setValueByName(t):t?n:n.clear()},setValueByName:function(t){if(t=I.trim(t+"")){var i=h("");if(i.name=g(t),i.withParents=!1,i.limit=10,!f("send_before",i))return l(null,i),n;a(),f("send"),b("source")(i,function(t){f("receive");for(var e=i.name.toLowerCase(),n=null,r=null,a=0;a<t.length;a++)if(n=t[a].name.toLowerCase(),e==n){r=t[a];break}l(r,i)})}return n},setValueById:function(t){var e=h("");return e.parentType=e.type,e.parentId=t,e.limit=1,a(),I.kladr.api(e,function(t){t.length?l(t[0],e):l(null,e)}),n},setValueByObject:function(t){return l(t,h("")),n},clear:function(){return l(null,null),n}},r="data-kladr-autofill-lock";function a(){T.attr(r,!0)}function l(t,e){t?T.val(b("valueFormat")(t,e)):m(!0),k(t),T.removeAttr(r)}w("controller",n)}(),u(),n=0,function t(){5<++n||function(){var t=T.val();if(t){var e=h(t),n=e.type,r=e.parentType,a=I.kladr.type,i=!0,l=b("controller").setValueByName;return n==a.street&&r!=a.city&&(i=!1),n!=a.building||~I.inArray(r,[a.street,a.city])||(i=!1),T.attr("data-kladr-autofill-lock")&&b("current")&&i&&l(t),!!b("current")}return!1}()||setTimeout(t,100)}()),t()}(function(){var n=!1,e=!0,r="";T.attr("data-kladr-type",b("type")||"").attr("data-kladr-one-string",b("oneString")||null).on("keyup"+i,t).on("keydown"+i,s).on("blur"+i,function(){!n&&T.data(o)&&r!=T.val()&&T.change()}).on("blur.kladr change"+i,function(t){if(!n)return"change"==t.type&&(r=T.val()),e&&(e=!1,function(){if(b("verify")&&f("check_before")){var t=I.trim(T.val());if(!t)return a(null,!1);if(b("current"))return m(!1);var r=h(t);if(r.withParents=!1,r.limit=10,!f("send_before",r))return a(null,!1),f("check",null);y(),f("send"),b("source")(r,function(t){if(f("receive"),I.trim(T.val())){r.name.toLowerCase();var e=null;n(e,!0),f("check",e)}else n(null,!1);function n(t,e){v(),a(t,e)}})}function a(t,e){m(e),k(t)}}()),!a&&C.checkEmptyRespone&&T.val(""),c(),!1}).on("focus"+i,function(){e=!0}),d.on("touchstart.kladr mousedown"+i,"li, a",function(t){var e;t.preventDefault(),n=!0,(e=I(this)).is("a")&&(e=e.parents("li")),e.addClass("active"),p(),c(),n=!1}),I(j).on("resize"+i,u)})}));if(i.isGet)return l=e,!1}),i.isGet?l:this}}(jQuery,window,document);